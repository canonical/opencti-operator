# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: opencti-{{ connector_name }}-connector
base: ubuntu@24.04
version: &version '{{ version }}'
summary: OpenCTI {{ display_name }} Connector
description: >-
  OpenCTI is an open source platform allowing organizations to manage their 
  cyber threat intelligence knowledge and observables. It has been created
  in order to structure, store, organize and visualize technical and 
  non-technical information about cyber threats.
platforms:
  amd64:

parts:
  {{ connector_name }}-connector:
    source: https://github.com/OpenCTI-Platform/connectors.git
    source-type: git
    source-tag: *version
    source-depth: 1
    plugin: nil
    build-packages:
      - python3-pip
    stage-packages:
      - python3-dev
      - libmagic1
      - libffi-dev
    override-build: |
      craftctl default
      ls -lah
      mkdir -p $CRAFT_PART_INSTALL/opt
      cd {{ constant_to_kebab(connector_type) }}/{{ connector_name }}
      cp -rp src $CRAFT_PART_INSTALL/opt/{{ install_location }}
      {{ generate_entrypoint }}
      cat entrypoint.sh | grep {{ install_location }}
      mkdir -p $CRAFT_PART_INSTALL/usr/local/lib/python3.12/dist-packages
      pip install \
        --target $CRAFT_PART_INSTALL/usr/local/lib/python3.12/dist-packages \
        -r $(find -name requirements.txt)
      cp entrypoint.sh $CRAFT_PART_INSTALL/
